#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
HeyGem å®Œæ•´ç‰ˆ Python API è°ƒç”¨è„šæœ¬ - F5-TTSé›†æˆç‰ˆ
å°†åŸæœ‰çš„TTSåˆæˆæ›¿æ¢ä¸ºF5-TTSï¼Œè·å¾—æ›´å¥½çš„è¯­éŸ³å…‹éš†æ•ˆæœ
"""

import requests
import json
import time
import uuid
import os
import shutil
import subprocess
import re
from pathlib import Path
from typing import Dict, Any, Optional

# F5-TTS å’Œæ•°å­—è½¬æ¢ç›¸å…³ä¾èµ–
try:
    import cn2an
    print("âœ… cn2an åº“åŠ è½½æˆåŠŸ")
except ImportError:
    print("âŒ é”™è¯¯: æœªå®‰è£… cn2an åº“")
    print("è¯·å®‰è£…: pip install cn2an")
    exit(1)


class HeyGemF5TTSAPI:
    """HeyGem F5-TTS é›†æˆç‰ˆ API å®¢æˆ·ç«¯ç±»"""
    
    def __init__(self, base_url: str = "http://127.0.0.1"):
        self.base_url = base_url
        self.video_port = 8383
        self.mount_root = Path("/home/kede/heygem_data")
        self.container_root = "/code/data"
        
        # åªä¿ç•™è§†é¢‘ç›¸å…³çš„APIç«¯ç‚¹ï¼Œè¯­éŸ³åˆæˆæ”¹ç”¨F5-TTS
        self.endpoints = {
            'video_submit': f"{base_url}:{self.video_port}/easy/submit",
            'video_query': f"{base_url}:{self.video_port}/easy/query"
        }
        
        # å·¥ä½œç›®å½•
        self.face_data_dir = "/home/kede/heygem_data/face2face"
        self.f5_tts_output_dir = "/home/kede/heygem_data/f5_tts_output"
        
        # F5-TTS é…ç½®
        self.f5_tts_model = "F5TTS_v1_Base"
        
    def check_services(self) -> Dict[str, bool]:
        """æ£€æŸ¥æœåŠ¡çŠ¶æ€"""
        services = {}
        
        # æ£€æŸ¥è§†é¢‘æœåŠ¡  
        try:
            response = requests.get(f"{self.base_url}:{self.video_port}/", timeout=10)
            services['video'] = response.status_code in [200, 404, 405]
        except Exception:
            services['video'] = False
        
        # æ£€æŸ¥F5-TTSå‘½ä»¤æ˜¯å¦å¯ç”¨
        try:
            result = subprocess.run(['f5-tts_infer-cli', '--help'], 
                                  capture_output=True, timeout=10)
            services['f5_tts'] = result.returncode == 0
        except Exception:
            services['f5_tts'] = False
            
        return services
    
    def validate_ref_audio(self, ref_audio_path: str) -> bool:
        """éªŒè¯å‚è€ƒéŸ³é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨ä¸”å¯ç”¨"""
        if not os.path.exists(ref_audio_path):
            print(f"âŒ å‚è€ƒéŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {ref_audio_path}")
            return False
            
        if os.path.getsize(ref_audio_path) == 0:
            print(f"âŒ å‚è€ƒéŸ³é¢‘æ–‡ä»¶ä¸ºç©º: {ref_audio_path}")
            return False
            
        print(f"âœ… å‚è€ƒéŸ³é¢‘æ–‡ä»¶éªŒè¯é€šè¿‡: {ref_audio_path}")
        return True
    
    def prepare_video_file(self, video_path: str) -> str:
        """å‡†å¤‡è§†é¢‘æ–‡ä»¶åˆ°æŒ‡å®šç›®å½•"""
        if not os.path.exists(video_path):
            raise FileNotFoundError(f"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {video_path}")
            
        # åˆ›å»ºç›®æ ‡ç›®å½•
        os.makedirs(self.face_data_dir, exist_ok=True)
        
        # ç”Ÿæˆæ–°çš„æ–‡ä»¶å
        timestamp = int(time.time())
        file_name = f"video_{timestamp}.mp4"
        target_path = os.path.join(self.face_data_dir, file_name)
        
        # å¤åˆ¶æ–‡ä»¶
        shutil.copy2(video_path, target_path)
        print(f"âœ… è§†é¢‘æ–‡ä»¶å·²å‡†å¤‡: {target_path}")
        
        return target_path
    
    def convert_number_with_cn2an(self, num_str):
        """ä½¿ç”¨cn2anè½¬æ¢å•ä¸ªæ•°å­—"""
        try:
            # å¤„ç†å°æ•°
            if '.' in num_str:
                integer_part, decimal_part = num_str.split('.')
                chinese_integer = cn2an.an2cn(int(integer_part))
                # å°æ•°éƒ¨åˆ†é€ä½è½¬æ¢
                chinese_decimal = 'ç‚¹' + ''.join([cn2an.an2cn(int(d)) for d in decimal_part])
                return chinese_integer + chinese_decimal
            else:
                # æ•´æ•°ç›´æ¥è½¬æ¢
                return cn2an.an2cn(int(num_str))
        except Exception as e:
            print(f"âš ï¸  æ•°å­—è½¬æ¢è­¦å‘Š: {num_str} â†’ {e}")
            return num_str  # è½¬æ¢å¤±è´¥æ—¶è¿”å›åŸæ•°å­—

    def convert_text_numbers_cn2an(self, text):
        """
        ä½¿ç”¨cn2anè½¬æ¢æ–‡æœ¬ä¸­çš„æ‰€æœ‰æ•°å­—ï¼Œæ­£ç¡®å¤„ç†æ•°å­¦ç¬¦å·
        ä¿®å¤ç‰ˆæœ¬ï¼šç¡®ä¿ 200+251=451 â†’ äºŒç™¾ åŠ  äºŒç™¾äº”åä¸€ ç­‰äº å››ç™¾äº”åä¸€
        """
        print(f"\nğŸ“ å¼€å§‹è½¬æ¢æ–‡æœ¬ä¸­çš„æ•°å­—...")
        print(f"åŸå§‹æ–‡æœ¬: {text}")
        
        # ç²¾ç¡®åŒ¹é…æ•°å­¦è¡¨è¾¾å¼çš„æ¨¡å¼
        patterns = [
            r'(\d+)\s*\+\s*(\d+)\s*=\s*(\d+)',  # åŠ æ³•ç­‰å¼ï¼š200+251=451
            r'(\d+)\s*-\s*(\d+)\s*=\s*(\d+)',   # å‡æ³•ç­‰å¼
            r'(\d+)\s*\*\s*(\d+)\s*=\s*(\d+)',  # ä¹˜æ³•ç­‰å¼
            r'(\d+)\s*/\s*(\d+)\s*=\s*(\d+)',   # é™¤æ³•ç­‰å¼
            r'(\d+)\s*\+\s*(\d+)',              # åŠ æ³•è¡¨è¾¾å¼ï¼š200+251
            r'(\d+)\s*-\s*(\d+)',               # å‡æ³•è¡¨è¾¾å¼
            r'(\d+)\s*\*\s*(\d+)',              # ä¹˜æ³•è¡¨è¾¾å¼
            r'(\d+)\s*/\s*(\d+)'                # é™¤æ³•è¡¨è¾¾å¼
        ]
        
        result = text
        
        # é€ä¸ªå¤„ç†æ¯ç§æ•°å­¦è¡¨è¾¾å¼æ¨¡å¼
        for pattern in patterns:
            matches = re.finditer(pattern, result)
            for match in reversed(list(matches)):  # ä»åå¾€å‰æ›¿æ¢ï¼Œé¿å…ä½ç½®åç§»
                original = match.group(0)
                print(f"  ğŸ§® æ‰¾åˆ°æ•°å­¦è¡¨è¾¾å¼: {original}")
                
                # æ ¹æ®è¿ç®—ç¬¦ç±»å‹è¿›è¡Œè½¬æ¢
                if '=' in original and '+' in original:
                    num1, num2, result_num = match.groups()
                    converted = f"{cn2an.an2cn(int(num1))} åŠ  {cn2an.an2cn(int(num2))} ç­‰äº {cn2an.an2cn(int(result_num))}"
                elif '=' in original and '-' in original:
                    num1, num2, result_num = match.groups()
                    converted = f"{cn2an.an2cn(int(num1))} å‡ {cn2an.an2cn(int(num2))} ç­‰äº {cn2an.an2cn(int(result_num))}"
                elif '=' in original and '*' in original:
                    num1, num2, result_num = match.groups()
                    converted = f"{cn2an.an2cn(int(num1))} ä¹˜ä»¥ {cn2an.an2cn(int(num2))} ç­‰äº {cn2an.an2cn(int(result_num))}"
                elif '=' in original and '/' in original:
                    num1, num2, result_num = match.groups()
                    converted = f"{cn2an.an2cn(int(num1))} é™¤ä»¥ {cn2an.an2cn(int(num2))} ç­‰äº {cn2an.an2cn(int(result_num))}"
                elif '+' in original:
                    num1, num2 = match.groups()
                    converted = f"{cn2an.an2cn(int(num1))} åŠ  {cn2an.an2cn(int(num2))}"
                elif '-' in original:
                    num1, num2 = match.groups()
                    converted = f"{cn2an.an2cn(int(num1))} å‡ {cn2an.an2cn(int(num2))}"
                elif '*' in original:
                    num1, num2 = match.groups()
                    converted = f"{cn2an.an2cn(int(num1))} ä¹˜ä»¥ {cn2an.an2cn(int(num2))}"
                elif '/' in original:
                    num1, num2 = match.groups()
                    converted = f"{cn2an.an2cn(int(num1))} é™¤ä»¥ {cn2an.an2cn(int(num2))}"
                else:
                    converted = original  # å¦‚æœæ— æ³•è¯†åˆ«ï¼Œä¿æŒåŸæ ·
                
                print(f"      è½¬æ¢ä¸º: {converted}")
                
                # æ›¿æ¢åŸæ–‡ä¸­çš„è¡¨è¾¾å¼
                start, end = match.span()
                result = result[:start] + converted + result[end:]
        
        print(f"æ•°å­¦è¡¨è¾¾å¼å¤„ç†å: {result}")
        
        # å¤„ç†å‰©ä½™çš„å•ç‹¬æ•°å­—
        try:
            final_result = cn2an.transform(result, "an2cn")
            print(f"æœ€ç»ˆç»“æœ: {final_result}")
            return final_result
            
        except Exception as e:
            print(f"âŒ cn2an.transform å¤„ç†å‰©ä½™æ•°å­—å¤±è´¥: {e}")
            
            # å¤‡ç”¨æ–¹æ¡ˆï¼šæ‰‹åŠ¨å¤„ç†å‰©ä½™æ•°å­—
            number_pattern = r'\b\d+(?:\.\d+)?\b'
            final_result = re.sub(number_pattern, lambda m: self.convert_number_with_cn2an(m.group()), result)
            print(f"å¤‡ç”¨æ–¹æ¡ˆç»“æœ: {final_result}")
            return final_result
    
    def synthesize_voice_with_f5tts(self, text: str, ref_audio_path: str, ref_text: str) -> Optional[str]:
        """
        æ­¥éª¤2: ä½¿ç”¨F5-TTSè¿›è¡Œè¯­éŸ³åˆæˆ
        æ›¿æ¢åŸæœ‰çš„HeyGem TTS APIè°ƒç”¨
        """
        print(f"ğŸ”„ å¼€å§‹F5-TTSè¯­éŸ³åˆæˆ: {text[:50]}...")
        
        # éªŒè¯å‚è€ƒéŸ³é¢‘æ–‡ä»¶
        if not self.validate_ref_audio(ref_audio_path):
            return None
            
        # é¢„å¤„ç†æ–‡æœ¬ï¼šè½¬æ¢æ•°å­—
        processed_text = self.convert_text_numbers_cn2an(text)
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        os.makedirs(self.f5_tts_output_dir, exist_ok=True)
        
        # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶å
        timestamp = int(time.time())
        output_filename = f"generated_audio_{timestamp}.wav"
        
        # æ„å»ºF5-TTSå‘½ä»¤
        cmd = [
            "f5-tts_infer-cli",
            "--model", self.f5_tts_model,
            "--ref_audio", ref_audio_path,
            "--ref_text", ref_text,
            "--gen_text", processed_text,
            "--output_dir", self.f5_tts_output_dir
        ]
        
        print(f"ğŸ“¤ F5-TTSå‘½ä»¤å‚æ•°:")
        print(f"   æ¨¡å‹: {self.f5_tts_model}")
        print(f"   å‚è€ƒéŸ³é¢‘: {ref_audio_path}")
        print(f"   å‚è€ƒæ–‡æœ¬: {ref_text}")
        print(f"   ç”Ÿæˆæ–‡æœ¬: {processed_text}")
        print(f"   è¾“å‡ºç›®å½•: {self.f5_tts_output_dir}")
        
        try:
            # æ‰§è¡ŒF5-TTSæ¨ç†
            print("ğŸš€ æ‰§è¡ŒF5-TTSæ¨ç†...")
            result = subprocess.run(cmd, capture_output=True, text=True, encoding='utf-8', timeout=300)
            
            if result.returncode == 0:
                print("âœ… F5-TTSè¯­éŸ³åˆæˆæˆåŠŸï¼")
                
                # æŸ¥æ‰¾ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶
                # F5-TTSé€šå¸¸ä¼šç”Ÿæˆä¸€ä¸ªä»¥æ—¶é—´æˆ³å‘½åçš„æ–‡ä»¶
                output_files = list(Path(self.f5_tts_output_dir).glob("*.wav"))
                if output_files:
                    # è·å–æœ€æ–°ç”Ÿæˆçš„æ–‡ä»¶
                    latest_file = max(output_files, key=os.path.getctime)
                    print(f"ğŸµ ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶: {latest_file}")
                    return str(latest_file)
                else:
                    print("âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„éŸ³é¢‘æ–‡ä»¶")
                    return None
                    
            else:
                print(f"âŒ F5-TTSè¯­éŸ³åˆæˆå¤±è´¥: {result.stderr}")
                return None
                
        except subprocess.TimeoutExpired:
            print("âŒ F5-TTSæ‰§è¡Œè¶…æ—¶")
            return None
        except Exception as e:
            print(f"âŒ F5-TTSæ‰§è¡Œå¼‚å¸¸: {e}")
            return None
    
    def submit_video_synthesis(self, audio_path: str, video_path: str) -> Optional[str]:
        """
        æ­¥éª¤3: æäº¤è§†é¢‘åˆæˆä»»åŠ¡
        """
        print("ğŸ”„ æäº¤è§†é¢‘åˆæˆä»»åŠ¡...")
        
        # ç”Ÿæˆä»»åŠ¡ID
        task_id = str(uuid.uuid4())
        
        # å¤„ç†éŸ³é¢‘è·¯å¾„
        if os.path.exists(audio_path):
            # å¤åˆ¶éŸ³é¢‘æ–‡ä»¶åˆ°è§†é¢‘æœåŠ¡å¯è®¿é—®çš„ç›®å½•
            audio_filename = f"f5tts_audio_{int(time.time())}.wav"
            target_audio_path = os.path.join(self.face_data_dir, audio_filename)
            shutil.copy2(audio_path, target_audio_path)
            print(f"ğŸ“ éŸ³é¢‘æ–‡ä»¶å·²å¤åˆ¶åˆ°: {target_audio_path}")
            
            # å®¹å™¨å†…è·¯å¾„
            container_audio_path = f"/code/data/{audio_filename}"
        else:
            raise FileNotFoundError(f"éŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {audio_path}")

        # å¤„ç†è§†é¢‘è·¯å¾„
        if video_path.startswith("/home/kede/heygem_data/face2face/"):
            video_filename = Path(video_path).name
            container_video_path = f"/code/data/{video_filename}"
        else:
            container_video_path = video_path
        
        payload = {
            "audio_url": container_audio_path,
            "video_url": container_video_path,
            "code": task_id,
            "chaofen": 0,
            "watermark_switch": 0,
            "pn": 1
        }
        
        headers = {'Content-Type': 'application/json'}
        
        print(f"ğŸ“¤ è§†é¢‘åˆæˆå‚æ•°:")
        print(f"   éŸ³é¢‘è·¯å¾„: {container_audio_path}")
        print(f"   è§†é¢‘è·¯å¾„: {container_video_path}")
        print(f"   ä»»åŠ¡ID: {task_id}")
        
        try:
            response = requests.post(
                self.endpoints['video_submit'],
                headers=headers,
                json=payload,
                timeout=60
            )
            
            print(f"ğŸ“¥ å“åº”çŠ¶æ€: {response.status_code}")
            print(f"ğŸ“¥ å“åº”å†…å®¹: {response.text}")
            
            if response.status_code == 200:
                print(f"âœ… è§†é¢‘åˆæˆä»»åŠ¡å·²æäº¤ï¼Œä»»åŠ¡ID: {task_id}")
                return task_id
            else:
                print(f"âŒ è§†é¢‘åˆæˆæäº¤å¤±è´¥: {response.status_code}")
                return None
                
        except Exception as e:
            print(f"âŒ è§†é¢‘åˆæˆæäº¤å¼‚å¸¸: {e}")
            return None
    
    def query_video_progress(self, task_id: str) -> Dict[str, Any]:
        """æŸ¥è¯¢è§†é¢‘åˆæˆè¿›åº¦"""
        try:
            response = requests.get(
                f"{self.endpoints['video_query']}?code={task_id}",
                timeout=30
            )
            
            if response.status_code == 200:
                return response.json()
            else:
                print(f"âŒ æŸ¥è¯¢è¿›åº¦å¤±è´¥: {response.status_code} - {response.text}")
                return {}
                
        except Exception as e:
            print(f"âŒ æŸ¥è¯¢è¿›åº¦å¼‚å¸¸: {e}")
            return {}
    
    def wait_for_completion(self, task_id: str, max_wait_time: int = 600) -> Optional[str]:
        """
        ç­‰å¾…è§†é¢‘åˆæˆå®Œæˆ
        """
        print("â³ ç­‰å¾…è§†é¢‘åˆæˆå®Œæˆ...")
        start_time = time.time()
        
        while time.time() - start_time < max_wait_time:
            progress = self.query_video_progress(task_id)
            
            if progress and 'data' in progress:
                data = progress['data']
                status_code = data.get("status", 0)
                msg = data.get("msg", "")
                result_path = data.get("result", "")
                
                print(f"   çŠ¶æ€: {status_code}, æ¶ˆæ¯: {msg}")
                
                if status_code == 2:  # å®Œæˆ
                    print(f"ğŸ‰ è§†é¢‘åˆæˆå®Œæˆ: {result_path}")
                    return result_path
                elif status_code == 3:  # å¤±è´¥
                    print(f"âŒ è§†é¢‘åˆæˆå¤±è´¥: {msg}")
                    return None
                elif "ä¸‰æ¬¡è·å–éŸ³é¢‘æ—¶é•¿å¤±è´¥" in str(msg):
                    print(f"âŒ éŸ³é¢‘å…¼å®¹æ€§é—®é¢˜: {msg}")
                    return None
                
            time.sleep(10)  # æ¯10ç§’æŸ¥è¯¢ä¸€æ¬¡
        
        print("â° ç­‰å¾…è¶…æ—¶")
        return None


def debug_setup():
    """æ£€æŸ¥å’Œå‡†å¤‡ç¯å¢ƒ"""
    print("=== ç¯å¢ƒæ£€æŸ¥å’Œè®¾ç½® ===")
    
    # æ£€æŸ¥å¿…è¦çš„ç›®å½•
    directories = [
        "/home/kede/heygem_data/face2face",
        "/home/kede/heygem_data/f5_tts_output"
    ]
    
    for dir_path in directories:
        Path(dir_path).mkdir(parents=True, exist_ok=True)
        print(f"âœ… ç›®å½•å·²å‡†å¤‡: {dir_path}")
    
    # æ£€æŸ¥cn2an
    try:
        test_num = cn2an.an2cn(123)
        print(f"âœ… cn2anæµ‹è¯•: 123 â†’ {test_num}")
    except Exception as e:
        print(f"âŒ cn2anæµ‹è¯•å¤±è´¥: {e}")
    
    # æ£€æŸ¥FFmpeg
    try:
        result = subprocess.run(['ffmpeg', '-version'], capture_output=True, timeout=5)
        if result.returncode == 0:
            print("âœ… FFmpegå¯ç”¨")
        else:
            print("âŒ FFmpegä¸å¯ç”¨")
    except Exception as e:
        print(f"âŒ FFmpegæ£€æŸ¥å¤±è´¥: {e}")
    
    # æ£€æŸ¥F5-TTS
    try:
        result = subprocess.run(['f5-tts_infer-cli', '--help'], capture_output=True, timeout=5)
        if result.returncode == 0:
            print("âœ… F5-TTSå‘½ä»¤è¡Œå·¥å…·å¯ç”¨")
        else:
            print("âŒ F5-TTSå‘½ä»¤è¡Œå·¥å…·ä¸å¯ç”¨")
    except Exception as e:
        print(f"âŒ F5-TTSæ£€æŸ¥å¤±è´¥: {e}")
        print("è¯·ç¡®ä¿å·²å®‰è£…F5-TTS: pip install f5-tts")


def run_complete_workflow_with_f5tts():
    """è¿è¡ŒF5-TTSé›†æˆç‰ˆçš„å®Œæ•´æ•°å­—äººåˆ›å»ºå·¥ä½œæµç¨‹"""
    
    # é…ç½®å‚æ•° - ä¿®æ­£ç‰ˆ
    input_video = "./face2face/wang.mp4"  # ç›®æ ‡è§†é¢‘æ–‡ä»¶
    ref_audio = ./voice_leijun.wav"     # F5-TTSå‚è€ƒéŸ³é¢‘æ–‡ä»¶
    ref_text = "å¦‚æœä½ æƒ³åšä¸€ä»¶äº‹ï¼Œå°±å…ˆå»å¹²ï¼Œ å“ªæ€•åšçš„å¾ˆçƒ‚ï¼Œå“ªæ€•ä¸€ç‚¹éƒ½ä¸å®Œç¾ï¼Œä¸€ä¸ªç²—ç³™çš„å¼€å§‹å°±æ˜¯æœ€å¥½çš„å¼€å§‹"  # å‚è€ƒéŸ³é¢‘çš„æ–‡æœ¬å†…å®¹
    text_to_speak = "ä½ å¥½ï¼Œæˆ‘æ˜¯é€šè¿‡AIæŠ€æœ¯åˆ›å»ºçš„æ•°å­—äººã€‚è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è§†é¢‘ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨HeyGemå’ŒF5-TTSæ¥åˆ›å»ºä¸ªæ€§åŒ–çš„æ•°å­—äººè§†é¢‘å†…å®¹ã€‚æŠ€æœ¯æ”¹å˜ä¸–ç•Œï¼ŒAIè®©æœªæ¥æ›´ç²¾å½©ã€‚"  # è¦åˆæˆçš„æ–°æ–‡æœ¬
    
    print("=== HeyGem + F5-TTS æ•°å­—äººåˆæˆå·¥ä½œæµç¨‹ ===")
    
    # ç¯å¢ƒæ£€æŸ¥
    debug_setup()
    
    # åˆå§‹åŒ–APIå®¢æˆ·ç«¯
    api = HeyGemF5TTSAPI()
    
    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    print("\nğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€...")
    services = api.check_services()
    for service, status in services.items():
        print(f"   {service}: {'âœ… å¯ç”¨' if status else 'âŒ ä¸å¯ç”¨'}")
    
    if not services.get('video', False):
        print("âŒ è§†é¢‘æœåŠ¡æœªæ­£å¸¸è¿è¡Œï¼Œè¯·æ£€æŸ¥Dockerå®¹å™¨çŠ¶æ€")
        return
    
    if not services.get('f5_tts', False):
        print("âŒ F5-TTSä¸å¯ç”¨ï¼Œè¯·ç¡®ä¿å·²æ­£ç¡®å®‰è£…")
        return
    
    try:
        # æ£€æŸ¥è¾“å…¥æ–‡ä»¶
        if not os.path.exists(input_video):
            print(f"âŒ ç›®æ ‡è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {input_video}")
            return
            
        if not os.path.exists(ref_audio):
            print(f"âŒ F5-TTSå‚è€ƒéŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {ref_audio}")
            return
        
        print(f"\nğŸ“ ç›®æ ‡è§†é¢‘: {input_video}")
        print(f"ğŸµ å‚è€ƒéŸ³é¢‘: {ref_audio}")
        print(f"ğŸ“ å‚è€ƒæ–‡æœ¬: {ref_text}")
        print(f"ğŸ“ åˆæˆæ–‡æœ¬: {text_to_speak}")
        
        # æ­¥éª¤1: å‡†å¤‡è§†é¢‘æ–‡ä»¶
        print("\n=== æ­¥éª¤1: å‡†å¤‡è§†é¢‘æ–‡ä»¶ ===")
        server_video_path = api.prepare_video_file(input_video)
        
        # æ­¥éª¤2: F5-TTSè¯­éŸ³åˆæˆ
        print("\n=== æ­¥éª¤2: F5-TTSè¯­éŸ³åˆæˆ ===")
        synthesized_audio_path = api.synthesize_voice_with_f5tts(
            text=text_to_speak,
            ref_audio_path=ref_audio,  # ä½¿ç”¨ç‹¬ç«‹çš„å‚è€ƒéŸ³é¢‘æ–‡ä»¶
            ref_text=ref_text          # ä½¿ç”¨æä¾›çš„å‚è€ƒæ–‡æœ¬
        )
        
        if not synthesized_audio_path:
            print("âŒ F5-TTSè¯­éŸ³åˆæˆå¤±è´¥ï¼Œé€€å‡º")
            return
        
        # æ­¥éª¤3: è§†é¢‘åˆæˆ
        print("\n=== æ­¥éª¤3: è§†é¢‘åˆæˆ ===")
        task_id = api.submit_video_synthesis(synthesized_audio_path, server_video_path)
        
        if not task_id:
            print("âŒ è§†é¢‘åˆæˆæäº¤å¤±è´¥ï¼Œé€€å‡º")
            return
        
        # æ­¥éª¤4: ç­‰å¾…å®Œæˆ
        print("\n=== æ­¥éª¤4: ç­‰å¾…åˆæˆå®Œæˆ ===")
        final_video = api.wait_for_completion(task_id, max_wait_time=600)
        
        if final_video:
            print(f"\nğŸ‰ æˆåŠŸï¼æ•°å­—äººè§†é¢‘ç”Ÿæˆå®Œæˆï¼")
            print(f"ğŸ“¹ è¾“å‡ºè§†é¢‘: {final_video}")
            print(f"ğŸµ åˆæˆéŸ³é¢‘: {synthesized_audio_path}")
            print(f"ğŸ¤ ä½¿ç”¨çš„å‚è€ƒå£°éŸ³: {ref_audio}")
        else:
            print(f"\nâŒ è§†é¢‘ç”Ÿæˆå¤±è´¥æˆ–è¶…æ—¶")
            
    except KeyboardInterrupt:
        print("\nâš ï¸ ç”¨æˆ·ä¸­æ–­æ“ä½œ")
    except Exception as e:
        print(f"\nğŸ’¥ è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°å¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()


def test_f5tts_text_conversion():
    """æµ‹è¯•F5-TTSçš„æ–‡æœ¬è½¬æ¢åŠŸèƒ½"""
    print("\nğŸ§ª æµ‹è¯•F5-TTSæ–‡æœ¬è½¬æ¢åŠŸèƒ½")
    print("=" * 50)
    
    api = HeyGemF5TTSAPI()
    
    test_texts = [
        "200+251=451è¿™ä¸ªæ•°å­¦å¾ˆç®€å•",
        "ä»Šå¤©æ˜¯2024å¹´1æœˆ1æ—¥",
        "æˆ‘æœ‰123ä¸ªè‹¹æœå’Œ45.5å…ƒé’±",
        "100*2=200ï¼Œ500/5=100"
    ]
    
    for text in test_texts:
        print(f"\nåŸæ–‡: {text}")
        converted = api.convert_text_numbers_cn2an(text)
        print(f"è½¬æ¢: {converted}")


if __name__ == "__main__":
    import sys
    
    if len(sys.argv) > 1:
        if sys.argv[1] == "debug":
            # åªè¿è¡Œè°ƒè¯•åŠŸèƒ½
            debug_setup()
        elif sys.argv[1] == "test":
            # æµ‹è¯•æ–‡æœ¬è½¬æ¢
            test_f5tts_text_conversion()
        else:
            print("ç”¨æ³•:")
            print("  python script.py        # è¿è¡Œå®Œæ•´å·¥ä½œæµç¨‹")
            print("  python script.py debug  # åªè¿è¡Œç¯å¢ƒæ£€æŸ¥")
            print("  python script.py test   # æµ‹è¯•æ–‡æœ¬è½¬æ¢åŠŸèƒ½")
    else:
        # è¿è¡Œå®Œæ•´ç‰ˆæœ¬
        run_complete_workflow_with_f5tts()
