#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
F5-TTS Pythonæ¨ç†è„šæœ¬ - ä½¿ç”¨cn2anè¿›è¡Œæ•°å­—è½¬æ¢
ä¸“é—¨ä½¿ç”¨cn2anåº“è¿›è¡Œé˜¿æ‹‰ä¼¯æ•°å­—åˆ°ä¸­æ–‡çš„è½¬æ¢

å®‰è£…ä¾èµ–:
pip install cn2an

cn2anåŠŸèƒ½ä»‹ç»:
- an2cn(): é˜¿æ‹‰ä¼¯æ•°å­—è½¬ä¸­æ–‡æ•°å­—
- cn2an(): ä¸­æ–‡æ•°å­—è½¬é˜¿æ‹‰ä¼¯æ•°å­—  
- transform(): æ™ºèƒ½è½¬æ¢ï¼Œè‡ªåŠ¨è¯†åˆ«æ•°å­—ç±»å‹
"""

import os
import re
import subprocess
import argparse
from pathlib import Path

try:
    import cn2an
    print("âœ… cn2an åº“åŠ è½½æˆåŠŸ")
except ImportError:
    print("âŒ é”™è¯¯: æœªå®‰è£… cn2an åº“")
    print("è¯·å®‰è£…: pip install cn2an")
    exit(1)

def test_cn2an_functions():
    """
    æµ‹è¯•cn2anåº“çš„å„ç§åŠŸèƒ½
    """
    print("\nğŸ§ª cn2an åŠŸèƒ½æµ‹è¯•:")
    print("-" * 40)
    
    # æµ‹è¯•åŸºæœ¬æ•°å­—è½¬æ¢
    test_numbers = [0, 1, 10, 11, 20, 100, 101, 1000, 1234, 12345]
    
    print("ğŸ“Š åŸºæœ¬æ•°å­—è½¬æ¢æµ‹è¯•:")
    for num in test_numbers:
        try:
            chinese = cn2an.an2cn(num)
            print(f"  {num:>6} â†’ {chinese}")
        except Exception as e:
            print(f"  {num:>6} â†’ è½¬æ¢å¤±è´¥: {e}")
    
    # æµ‹è¯•å°æ•°è½¬æ¢
    print("\nğŸ“Š å°æ•°è½¬æ¢æµ‹è¯•:")
    decimal_numbers = [1.5, 10.25, 100.99, 0.5]
    for num in decimal_numbers:
        try:
            # cn2anä¸ç›´æ¥æ”¯æŒå°æ•°ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†
            integer_part = int(num)
            decimal_part = str(num).split('.')[1]
            chinese_integer = cn2an.an2cn(integer_part)
            chinese_decimal = 'ç‚¹' + ''.join([cn2an.an2cn(int(d)) for d in decimal_part])
            result = chinese_integer + chinese_decimal
            print(f"  {num:>6} â†’ {result}")
        except Exception as e:
            print(f"  {num:>6} â†’ è½¬æ¢å¤±è´¥: {e}")
    
    # æµ‹è¯•transformåŠŸèƒ½
    print("\nğŸ“Š æ™ºèƒ½è½¬æ¢æµ‹è¯•:")
    test_texts = ["æˆ‘æœ‰123ä¸ªè‹¹æœ", "ä»·æ ¼æ˜¯99.9å…ƒ", "2024å¹´1æœˆ1æ—¥"]
    for text in test_texts:
        try:
            result = cn2an.transform(text, "an2cn")
            print(f"  åŸæ–‡: {text}")
            print(f"  è½¬æ¢: {result}")
        except Exception as e:
            print(f"  {text} â†’ è½¬æ¢å¤±è´¥: {e}")

def convert_number_with_cn2an(num_str):
    """
    ä½¿ç”¨cn2anè½¬æ¢å•ä¸ªæ•°å­—
    """
    try:
        # å¤„ç†å°æ•°
        if '.' in num_str:
            integer_part, decimal_part = num_str.split('.')
            chinese_integer = cn2an.an2cn(int(integer_part))
            # å°æ•°éƒ¨åˆ†é€ä½è½¬æ¢
            chinese_decimal = 'ç‚¹' + ''.join([cn2an.an2cn(int(d)) for d in decimal_part])
            return chinese_integer + chinese_decimal
        else:
            # æ•´æ•°ç›´æ¥è½¬æ¢
            return cn2an.an2cn(int(num_str))
    except Exception as e:
        print(f"âš ï¸  æ•°å­—è½¬æ¢è­¦å‘Š: {num_str} â†’ {e}")
        return num_str  # è½¬æ¢å¤±è´¥æ—¶è¿”å›åŸæ•°å­—

def convert_math_expression(expr_str):
    """
    è½¬æ¢æ•°å­¦è¡¨è¾¾å¼
    """
    try:
        # åˆ†ç¦»è¡¨è¾¾å¼å’Œç»“æœ
        if '=' in expr_str:
            expression, result = expr_str.split('=', 1)
        else:
            expression = expr_str
            result = None
        
        # æ›¿æ¢è¿ç®—ç¬¦
        chinese_expr = expression.strip()
        chinese_expr = re.sub(r'\+', ' åŠ  ', chinese_expr)
        chinese_expr = re.sub(r'-', ' å‡ ', chinese_expr)
        chinese_expr = re.sub(r'\*', ' ä¹˜ä»¥ ', chinese_expr)
        chinese_expr = re.sub(r'/', ' é™¤ä»¥ ', chinese_expr)
        
        # è½¬æ¢è¡¨è¾¾å¼ä¸­çš„æ•°å­—
        number_pattern = r'\d+(?:\.\d+)?'
        chinese_expr = re.sub(number_pattern, 
                             lambda m: convert_number_with_cn2an(m.group()), 
                             chinese_expr)
        
        # å¤„ç†ç»“æœéƒ¨åˆ†
        if result:
            chinese_result = convert_number_with_cn2an(result.strip())
            return chinese_expr + ' ç­‰äº ' + chinese_result
        else:
            return chinese_expr
            
    except Exception as e:
        print(f"âš ï¸  è¡¨è¾¾å¼è½¬æ¢è­¦å‘Š: {expr_str} â†’ {e}")
        return expr_str

def convert_text_numbers_cn2an(text):
    """
    ä½¿ç”¨cn2anè½¬æ¢æ–‡æœ¬ä¸­çš„æ‰€æœ‰æ•°å­—
    """
    print(f"\nğŸ“ å¼€å§‹è½¬æ¢æ–‡æœ¬ä¸­çš„æ•°å­—...")
    print(f"åŸå§‹æ–‡æœ¬: {text}")
    
    # æ–¹æ³•1: ä½¿ç”¨cn2ançš„transformåŠŸèƒ½ï¼ˆæ¨èï¼‰
    try:
        # cn2an.transform å¯ä»¥æ™ºèƒ½è¯†åˆ«å¹¶è½¬æ¢æ–‡æœ¬ä¸­çš„æ•°å­—
        result = cn2an.transform(text, "an2cn")
        print(f"cn2an.transformç»“æœ: {result}")
        
        # é¢å¤–å¤„ç†æ•°å­¦è¡¨è¾¾å¼
        math_pattern = r'\b\d+(?:\.\d+)?\s*[+\-*/]\s*\d+(?:\.\d+)?(?:\s*=\s*\d+(?:\.\d+)?)?\b'
        
        def replace_math(match):
            return convert_math_expression(match.group())
        
        final_result = re.sub(math_pattern, replace_math, result)
        print(f"æœ€ç»ˆç»“æœ: {final_result}")
        
        return final_result
        
    except Exception as e:
        print(f"âŒ cn2an.transform è½¬æ¢å¤±è´¥: {e}")
        
        # æ–¹æ³•2: æ‰‹åŠ¨å¤„ç†ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
        print("ğŸ”„ ä½¿ç”¨æ‰‹åŠ¨è½¬æ¢æ–¹æ¡ˆ...")
        
        # å…ˆå¤„ç†æ•°å­¦è¡¨è¾¾å¼
        math_pattern = r'\b\d+(?:\.\d+)?\s*[+\-*/]\s*\d+(?:\.\d+)?(?:\s*=\s*\d+(?:\.\d+)?)?\b'
        result = re.sub(math_pattern, lambda m: convert_math_expression(m.group()), text)
        
        # å†å¤„ç†å‰©ä½™çš„å•ç‹¬æ•°å­—
        number_pattern = r'\b\d+(?:\.\d+)?\b'
        result = re.sub(number_pattern, lambda m: convert_number_with_cn2an(m.group()), result)
        
        return result

def run_f5_tts_with_cn2an(model, ref_audio, ref_text, gen_text, output_dir):
    """
    è¿è¡Œ F5-TTS æ¨ç†ï¼Œä½¿ç”¨cn2anè¿›è¡Œæ•°å­—è½¬æ¢
    """
    print("\nğŸš€ å¼€å§‹ F5-TTS æ¨ç†...")
    print("=" * 60)
    
    # ä½¿ç”¨cn2ané¢„å¤„ç†ç”Ÿæˆæ–‡æœ¬
    processed_gen_text = convert_text_numbers_cn2an(gen_text)
    
    print(f"\nğŸ“‹ è½¬æ¢å¯¹æ¯”:")
    print(f"åŸå§‹æ–‡æœ¬: {gen_text}")
    print(f"è½¬æ¢æ–‡æœ¬: {processed_gen_text}")
    
    # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
    Path(output_dir).mkdir(parents=True, exist_ok=True)
    
    # æ„å»ºå‘½ä»¤
    cmd = [
        "f5-tts_infer-cli",
        "--model", model,
        "--ref_audio", ref_audio,
        "--ref_text", ref_text,
        "--gen_text", processed_gen_text,
        "--output_dir", output_dir
    ]
    
    print(f"\nğŸ’» æ‰§è¡Œå‘½ä»¤:")
    print(" ".join([f'"{arg}"' if ' ' in arg else arg for arg in cmd]))
    
    try:
        # è¿è¡Œå‘½ä»¤
        result = subprocess.run(cmd, capture_output=True, text=True, encoding='utf-8')
        
        if result.returncode == 0:
            print("\nâœ… F5-TTS æ¨ç†æˆåŠŸå®Œæˆï¼")
            print(f"ğŸ“ è¾“å‡ºä¿å­˜åˆ°: {output_dir}")
            if result.stdout:
                print(f"ğŸ“‹ è¾“å‡ºä¿¡æ¯: {result.stdout}")
        else:
            print("\nâŒ F5-TTS æ¨ç†å¤±è´¥ï¼")
            print(f"âŒ é”™è¯¯ä¿¡æ¯: {result.stderr}")
            
        return result.returncode == 0
        
    except FileNotFoundError:
        print("\nâŒ é”™è¯¯: æ‰¾ä¸åˆ° f5-tts_infer-cli å‘½ä»¤")
        print("è¯·ç¡®ä¿å·²æ­£ç¡®å®‰è£… F5-TTS å¹¶ä¸”å‘½ä»¤åœ¨ PATH ä¸­")
        return False
    except Exception as e:
        print(f"\nâŒ è¿è¡Œè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: {e}")
        return False

def main():
    parser = argparse.ArgumentParser(description='F5-TTS Python æ¨ç†è„šæœ¬ï¼ˆä½¿ç”¨cn2anæ•°å­—è½¬æ¢ï¼‰')
    parser.add_argument('--model', default='F5TTS_v1_Base', help='æ¨¡å‹åç§°')
    parser.add_argument('--ref_audio', required=True, help='å‚è€ƒéŸ³é¢‘æ–‡ä»¶è·¯å¾„')
    parser.add_argument('--ref_text', required=True, help='å‚è€ƒæ–‡æœ¬')
    parser.add_argument('--gen_text', required=True, help='è¦ç”Ÿæˆçš„æ–‡æœ¬')
    parser.add_argument('--output_dir', default='./output_f5_tts', help='è¾“å‡ºç›®å½•')
    parser.add_argument('--test', action='store_true', help='è¿è¡Œcn2anåŠŸèƒ½æµ‹è¯•')
    
    args = parser.parse_args()
    
    # è¿è¡Œæµ‹è¯•
    if args.test:
        test_cn2an_functions()
        return True
    
    # æ£€æŸ¥å‚è€ƒéŸ³é¢‘æ–‡ä»¶
    if not os.path.exists(args.ref_audio):
        print(f"âŒ é”™è¯¯: å‚è€ƒéŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {args.ref_audio}")
        return False
    
    # è¿è¡Œ F5-TTS
    success = run_f5_tts_with_cn2an(
        model=args.model,
        ref_audio=args.ref_audio,
        ref_text=args.ref_text,
        gen_text=args.gen_text,
        output_dir=args.output_dir
    )
    
    return success

if __name__ == "__main__":
    print("ğŸµ F5-TTS cn2an æ•°å­—è½¬æ¢è„šæœ¬")
    print("=" * 60)
    
    # å¦‚æœæ²¡æœ‰å‚æ•°ï¼Œè¿è¡Œç¤ºä¾‹
    if len(os.sys.argv) == 1:
        print("ğŸ“– è¿è¡Œå†…ç½®ç¤ºä¾‹...")
        
        # å…ˆè¿è¡Œæµ‹è¯•
        print("\nğŸ§ª è¿è¡Œ cn2an åŠŸèƒ½æµ‹è¯•:")
        test_cn2an_functions()
        
        # ç¤ºä¾‹é…ç½®
        model = "F5TTS_v1_Base"
        ref_audio = "/home/kede/2025/F5-TTS/voice_leijun.wav"
        ref_text = "å¦‚æœä½ æƒ³åšä¸€ä»¶äº‹ï¼Œå°±å…ˆå»å¹²ï¼Œ å“ªæ€•åšçš„å¾ˆçƒ‚ï¼Œå“ªæ€•ä¸€ç‚¹éƒ½ä¸å®Œç¾ï¼Œä¸€ä¸ªç²—ç³™çš„å¼€å§‹å°±æ˜¯æœ€å¥½çš„å¼€å§‹"
        gen_text = "ä½ å¥½ï¼Œ200+251=451è¿™ä¸ªæ•°å­¦å¾ˆç®€å•ã€‚æˆ‘æ˜¯é€šè¿‡AIæŠ€æœ¯åˆ›å»ºçš„æ•°å­—äººã€‚è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•è§†é¢‘ï¼Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨HeyGemæ¥åˆ›å»ºä¸ªæ€§åŒ–çš„æ•°å­—äººè§†é¢‘å†…å®¹ã€‚æŠ€æœ¯æ”¹å˜ä¸–ç•Œï¼ŒAIè®©æœªæ¥æ›´ç²¾å½©ã€‚"
        output_dir = "./output_f5_tts"
        
        print(f"\nğŸ“ å‘½ä»¤è¡Œä½¿ç”¨ç¤ºä¾‹:")
        print("python f5_tts_cn2an.py \\")
        print(f'  --ref_audio "{ref_audio}" \\')
        print(f'  --ref_text "{ref_text}" \\')
        print(f'  --gen_text "{gen_text}" \\')
        print(f'  --output_dir "{output_dir}"')
        
        print(f"\nğŸ§ª ä»…è¿è¡Œæµ‹è¯•:")
        print("python f5_tts_cn2an.py --test")
        
        # æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if not os.path.exists(ref_audio):
            print(f"\nâš ï¸  è­¦å‘Š: å‚è€ƒéŸ³é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {ref_audio}")
            print("è¯·ä¿®æ”¹è„šæœ¬ä¸­çš„ ref_audio è·¯å¾„ï¼Œæˆ–ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°æŒ‡å®šæ­£ç¡®è·¯å¾„")
            exit(1)
        
        success = run_f5_tts_with_cn2an(model, ref_audio, ref_text, gen_text, output_dir)
        exit(0 if success else 1)
    else:
        success = main()
        exit(0 if success else 1)
